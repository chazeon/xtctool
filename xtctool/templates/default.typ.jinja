{# Default Typst template for xtctool #}
{# Configurable parameters:
   - width_pt, height_pt: Page dimensions in points
   - margin_left, margin_right, margin_top, margin_bottom: Page margins
   - font: Font family (default: "Liberation Serif")
   - font_size: Font size in points (default: 11pt)
   - line_spacing: Line spacing multiplier (default: 1.2)
   - language: Language code (default: "en")
   - list_spacing: Space between list items (default: 8pt)
   - list_tight: Remove extra spacing in lists (default: false)
   - show_page_numbers: Show page numbers (default: true)
   - page_number_style: Style for page numbers - "plain", "fraction", "bar" (default: "fraction")
   - page_number_size: Page number font size (default: 10pt)
   - show_toc: Show table of contents (default: false)
   - toc_title: TOC title (default: "Contents")
   - markdown_file: Path to markdown file to include
#}

#set page(
  width: {{ width_pt }}pt,
  height: {{ height_pt }}pt,
  margin: (
    left: {{ margin_left|default(16) }}pt,
    right: {{ margin_right|default(16) }}pt,
    top: {{ margin_top|default(32) }}pt,
    bottom: {{ margin_bottom|default(32) }}pt,
  ),
{% if show_page_numbers|default(true) %}
{%- set style = page_number_style|default('fraction') %}
{%- if style in ['plain', 'fraction'] %}
  footer: context {
    set text(size: {{ page_number_size|default(12) }}pt)
    align(center)[
    #let current = counter(page).get().first()
{%- if style == 'plain' %}
    #current
{%- else %}
    #let total = counter(page).final().last()
    #current / #total
{%- endif %}
    #v(4pt)
    ]
  },
{%- elif style == 'bar' %}
  foreground: context {
    let current = counter(page).get().first()
    let total = counter(page).final().last()
    let ratio = current / total

    // --- 1. Define Geometry ---
    let page-w = {{ width_pt }}pt
    let m-left = {{ margin_left|default(16) }}pt
    let m-right = {{ margin_right|default(16) }}pt

    // --- 2. Measure Text ---
    // Note: Wrapped in box() to prevent line breaking on spaces
    let num-content = box(text(size: {{ page_number_size|default(12) }}pt)[#current / #total])
    let text-width = measure(num-content).width

    // --- 3. Calculate Position ---
    let bar-edge = ratio * page-w

    // Constraint A: Right edge must not go past the text area
    // (Page Width - Right Margin - Text Width) gives the max *start* position
    let max-x = page-w - m-right - text-width

    // Constraint B: Text must start at least at the left margin
    let min-x = m-left

    // Apply clamps: Ideal start position is (bar_tip - text_width)
    let text-pos-x = calc.max(min-x, calc.min(bar-edge - text-width, max-x))

    // --- 4. Draw Elements ---

    // The Page Number
    place(
      bottom + left,
      dx: text-pos-x,
      dy: -8pt,
      box(width: text-width, align(left, num-content))
    )

    // The Progress Bar
    align(bottom + left,
      block(width: 100%, height: 4pt, fill: luma(230))[
        #box(width: ratio * 100%, height: 100%, fill: black)
      ]
    )
  },
{%- endif %}
{%- endif %}
)

#set text(
  font: "{{ font|default('Liberation Serif') }}",
  size: {{ font_size|default(24) }}pt,
  lang: "{{ language|default('en') }}",
  hyphenate: true,
  costs: (
    hyphenation: 20%,
    orphan: 50%,
    widow: 50%,
  ),
)

#set par(
  leading: {{ line_spacing|default(0.7) }}em,
  justify: {{ justify|default('true') }},
  spacing: {{ line_spacing|default(0.7) }}em,
  first-line-indent: 1.0em,
{%- if justify|default('true') == 'true' %}
  justification-limits: (
    spacing: (min: 83.33% + 0pt, max: 120% + 0pt),
    tracking: (min: -0.01em, max: 0.02em),
  ),
{%- endif %}
)

#set list(
  spacing: auto,
  tight: false,
)

#set enum(
  spacing: auto,
  tight: false,
)

// Control spacing around list blocks (not between items)
#show list: it => block(above: 0.65em, below: 0.65em, it)
#show enum: it => block(above: 0.65em, below: 0.65em, it)

// Strip all links since e-paper isn't clickable
#show link: it => {
  // Just show the link text without the link
  if type(it.body) == content {
    it.body
  } else {
    str(it.dest)
  }
}

#show heading: it => block(above: 1.5em, below: 1em)[
  #set text(weight: "medium")
  #it.body
]

#show heading.where(level: 1): it => [

  #pagebreak(weak: true)
  
  #v(4em)
  
  #set align(center) // Center usually looks better for huge text
  #set text(weight: "regular", size: 1.2em)
  
  #block[
    #if it.numbering != none {
      counter(heading).display(it.numbering)
      h(0.5em) // Space between number and text
    }
    #it.body
  ]
  
  #v(2em)
]

{% if show_toc|default(false) %}
#outline(
  title: "{{ toc_title|default('Contents') }}",
)
#pagebreak()
{% endif %}

{% if markdown_file %}
#import "@preview/cmarker:0.1.7"

// Override image function to resolve paths correctly relative to markdown file
#cmarker.render(
  read("{{ markdown_file }}"),
  scope: (image: (source, alt: none, format: auto) => image(source, alt: alt, format: format))
)
{% else %}
{{ content|default('') }}
{% endif %}
